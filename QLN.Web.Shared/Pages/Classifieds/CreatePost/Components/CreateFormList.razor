@using MudBlazor
@using QLN.Web.Shared.Components.NewCustomSelect
@using QLN.Web.Shared.Components.CustomInput
@using QLN.Web.Shared.Pages.Classifieds.CreatePost.Components
@using QLN.Common.DTO_s;
@using MudExRichTextEditor
@inherits CreateFormListbase
@typeparam TItem

<div class="form-section">
    <h3 class="form-heading">Ad Category</h3>
    <div class="form-group">
        <NewCustomSelect TItem="OptionItem"
                         Items="@categoryOptions"
                         SelectedId="@adPostModel.SelectedVertical"
                         SelectedIdChanged="OnVerticalChanged"
                         GetId="x => x.Id"
                         GetLabel="x => x.Label"
                         Label="Subvertical"
                         Placeholder="Choose" />
    </div>
</div>

@if (!string.IsNullOrEmpty(adPostModel.SelectedVertical))
{
    var selectedCategory = CategoryTrees.FirstOrDefault(x => x.Id.ToString() == adPostModel.SelectedCategoryId);
    var selectedSubcategory = selectedCategory?.Children?.FirstOrDefault(x => x.Id.ToString() == adPostModel.SelectedSubcategoryId);
    var selectedSubSubcategory = selectedSubcategory?.Children?.FirstOrDefault(x => x.Id.ToString() == adPostModel.SelectedSubSubcategoryId);
    var fields = selectedSubSubcategory?.Fields ?? selectedSubcategory?.Fields ?? selectedCategory?.Fields;

    var allowedFields = new[] { "Condition", "Ram", "Model", "Capacity", "Processor", "Brand", "Storage", "Colour", "Gender", "Resolution", "Coverage" };
    @if (adPostModel.SelectedVertical != "deals")
    {
        <div class="form-section">
            <h6 class="form-heading">Ad Information</h6>

            <div class="form-group">
                <NewCustomSelect TItem="CategoryTreeDto"
                                 Items="@CategoryTrees"
                                 GetId="x => x.Id.ToString()"
                                 GetLabel="x => x.Name"
                                 Label="Category"
                                 Placeholder="Choose"
                                 SelectedId="@adPostModel.SelectedCategoryId"
                                 SelectedIdChanged="OnCategoryChanged" />
            </div>
            @if (selectedCategory?.Children?.Any() == true)
            {
                <div class="form-group">
                    <NewCustomSelect TItem="CategoryTreeDto"
                                     Items="@selectedCategory.Children"
                                     GetId="x => x.Id.ToString()"
                                     GetLabel="x => x.Name"
                                     Label="Subcategory"
                                     Placeholder="Choose"
                                     SelectedId="@adPostModel.SelectedSubcategoryId"
                                     SelectedIdChanged="OnSubcategoryChanged" />
                </div>
            }

            @if (selectedSubcategory?.Children?.Any() == true)
            {
                <div class="form-group">
                    <NewCustomSelect TItem="CategoryTreeDto"
                                     Items="@selectedSubcategory.Children"
                                     GetId="x => x.Id.ToString()"
                                     GetLabel="x => x.Name"
                                     Label="Sub Subcategory"
                                     Placeholder="Choose"
                                     SelectedId="@adPostModel.SelectedSubSubcategoryId"
                                     SelectedIdChanged="OnSubSubcategoryChanged" />
                </div>
            }

            @if (fields != null)
            {
                @foreach (var field in fields)
                {
                    if (allowedFields.Contains(field.Name))
                    {
                        var key = field.Name;
                        var selected = adPostModel.DynamicFields.ContainsKey(key) ? adPostModel.DynamicFields[key] : null;
                        <div class="form-group">
                            <NewCustomSelect TItem="OptionItem"
                                             Items="field.Options.Select(opt => new OptionItem { Id = opt, Label = opt }).ToList()"
                                             GetId="x => x.Id"
                                             GetLabel="x => x.Label"
                                             Label="@field.Name"
                                             Placeholder="Choose"
                                             SelectedId="@selected"
                                             SelectedIdChanged="@(val => adPostModel.DynamicFields[key] = val)" />
                        </div>
                    }
                }
                <div class="form-group">
                    <CustomInput TItem="decimal" Placeholder="Price" @bind-Value="adPostModel.Price" TextRight="QAR" />
                </div>
            }
        </div>
    }


    <div class="form-section">
        <h6 class="form-heading">Description and Features</h6>
        <div class="form-group">
            <CustomInput TItem="string" Placeholder="@(adPostModel.SelectedVertical == "deals" ? "Offer Title" : "Title")" @bind-Value="adPostModel.Title" />
        </div>
        @if (adPostModel.SelectedVertical != "deals")
        {
            <div class="form-group">
                <MudExRichTextEdit @bind-Value="adPostModel.ItemDescription"
                                   Height="300"
                                   Class="description-input no-underline"
                                   Placeholder="Write your business description..." />
            </div>
        }
        @if (adPostModel.SelectedVertical == "items")
        {
            <div class="form-group">
                <CustomInput TItem="string" Placeholder="Battery Percentage" @bind-Value="adPostModel.BatteryPercentage" TextRight="%" />
            </div>
        }

        <div class="form-group">
            <FileUploader OnFileUploadedWithMeta="HandleUpload" LabelText="@(adPostModel.SelectedVertical == "deals" ? "Flyer File" : "Certificate / Warranty*")" />
        </div>
        @if (adPostModel.SelectedVertical == "deals")
        {
            <div class="form-group">
                <CustomInput TItem="string" Placeholder="XML Link" @bind-Value="adPostModel.XmlLink" />
            </div>
        }
    </div>


    <div class="form-section">
        <h6 class="form-heading">Contact Details</h6>
        <div class="form-group">
            <CustomInput TItem="string" Placeholder="Phone Number" @bind-Value="adPostModel.Phone" />
        </div>
        <div class="form-group">
            <CustomInput TItem="string" Placeholder="WhatsApp Number" @bind-Value="adPostModel.Whatsapp" />
        </div>
    </div>

    <div class="form-section">
        <h6 class="form-heading">Location</h6>
        
        @if (adPostModel.SelectedVertical == "deals")
        {
            <div class="form-group">
                <CustomInput TItem="string" Placeholder="Location*" @bind-Value="adPostModel.FlyerLocation" />
            </div>
        }
        @if (adPostModel.SelectedVertical != "deals")
        {
            <div class="form-group">
                <CustomInput TItem="string" Placeholder="Zone" @bind-Value="adPostModel.Zone" />
            </div>
            <div class="form-group">
                <CustomInput TItem="string" Placeholder="Street Number" @bind-Value="adPostModel.StreetNumber" />
            </div>
            <div class="form-group">
                <CustomInput TItem="string" Placeholder="Building Number" @bind-Value="adPostModel.BuildingNumber" />
            </div>
            <div id="map" style="height: 300px; width: 100%;"></div>
            
        }

        
        <div @ref="mapDiv" id="map" style="height: 300px; width: 100%;"></div>
        <div class="checkbox-section">
            <div class="checkbox-left">
                <MudCheckBox @bind-Value="adPostModel.IsAgreed" Color="Color.Primary" />
            </div>
            <div class="checkbox-right">
                <span>
                    I agree to the
                    <a href="https://www.qatarliving.com/rules" target="_blank">Rules for Advertising</a>
                    and the
                    <a href="https://www.qatarliving.com/terms" target="_blank">Terms of Use</a>.
                </span>
            </div>
        </div>
    </div>
}



<style>
    .form-section {
        margin-bottom: 2rem;
        font-family: 'Public Sans', sans-serif;
    }

    .form-heading {
        color: var(--color-primary);
        font-size: 18px;
        margin-bottom: 1rem;
        font-weight: 600;
    }

    .form-group {
        margin-bottom: 1rem;
    }

    .map-container {
        width: 100%;
        overflow: hidden;
        border: 1px solid #D0D5DD;
        border-radius: 6px;
        margin-bottom: 1.5rem;
    }


    .map-frame {
        width: 100%;
        height: 300px;
        border: none;
    }

    .checkbox-section {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .checkbox-left {
        flex-shrink: 0;
    }

    .checkbox-right {
        font-size: 14px;
        color: #444;
    }

        .checkbox-right a {
            color: #F37021;
            text-decoration: none;
            font-weight: 500;
        }

            .checkbox-right a:hover {
                text-decoration: underline;
            }


    /* Optional: Responsive spacing or alignment */
    @@media (min-width: 768px) {
        .form-group {
            max-width: 500px;
        }
    }
</style>
