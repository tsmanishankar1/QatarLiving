@page "/login"
@inject ApiService Api
@inject ISnackbar Snackbar
@inject NavigationManager NavManager
@inject UserState UserState
@using QLN.Blazor.Base.Services
@using MudBlazor
@using QLN.Blazor.Base.Models
@using QLN.Web.Shared.Components.CustomButton
@using QLN.Web.Shared.Components.ModalDialog

<div style="width: 100vw; min-height: 100vh; background-color: var(--color-background); display: flex; justify-content: center; align-items: center;">
    <div style="width: 100%; max-width: 450px; padding: 2rem;">
        <MudText Typo="Typo.h4" Align="Align.Center" Class="mb-6 style-heading" >
        Log in to your account
    </MudText>
    <MudText Typo="Typo.h5" Align="Align.Center" Class="mb-4 style-description" >Welcome back! Please enter your details.</MudText>
    <MudText Typo="Typo.h5" Align="Align.Start" Class="mb-4">Email or Phone Number</MudText>
    <MudTextField T="string"
              Label="Enter your email"
              Variant="Variant.Outlined"
              FullWidth="true"
              InputType="InputType.Text"
              @bind-Value="_username"
              Required="true"
               />
    <MudText Typo="Typo.h5" Align="Align.Start" Class="mb-4">Password</MudText>
    <MudTextField T="string"
              Label="Enter your password"
              Variant="Variant.Outlined"
              FullWidth="true"
              InputType="InputType.Password"
              @bind-Value="_password"
              Required="true"
               />


    <div style="display: flex; justify-content: space-between; align-items: center; margin: 8px 0;">
    <MudCheckBox T="bool" @bind-Checked="_rememberMe" Color="Color.Warning" Class="my-checkbox">
    Remember me
   </MudCheckBox>

    <MudLink Href="/forgot-password" Style="color: #FF7F38; text-decoration: none;">
        Forgot Password?
    </MudLink>
</div>
   
<CustomButton 
    BackgroundColor= "var(--color-secondary)"
    TextColor="#FFFFFF"
    Text="Sign In"
    Disabled="_isLoading"
    Loading="_isLoading"
    OnClick="@PerformLogin"
    Class="mt-4" />


     <div class="d-flex align-center my-4">
        <div style="flex-grow: 1; height: 1px; background-color: #E3E3E3"></div>
        <MudText Typo="Typo.caption" Class="mx-2">Or continue with</MudText>
        <div style="flex-grow: 1; height: 1px; background-color: #ccc;"></div>
    </div>

    <MudStack Spacing="3">
    <MudButton Variant="Variant.Outlined"
           Color="Color.Transparent"
           Style="border-color: #D0D5DD; color: #787878;">
           <img src="images/google.svg" alt="Microsoft" style="height: 20px; margin-right: 8px;" />
    </MudButton>
        <MudButton Variant="Variant.Outlined" Color="Color.Default"  Style="border-color: #D0D5DD; color: #787878;">
            <img src="images/microsoft.svg" alt="Microsoft" style="height: 20px; margin-right: 8px;" />
            Continue with Microsoft
        </MudButton>
        <MudButton Variant="Variant.Outlined" Color="Color.Default" FullWidth="true" Style="border-color: #D0D5DD; color: #787878;">
            <img src="images/facebook.svg" alt="Microsoft" style="height: 20px; margin-right: 8px;" />
        </MudButton> 
    </MudStack>
    <MudText Align="Align.Start" Class="mt-4">
        Don't have an account? 
        <MudLink Href="/signup" Class="ml-1" Style="color: #FF7F38;">Sign Up</MudLink>
    </MudText>
</div>
</div>

@code {
    private string _username = string.Empty;
    private string _password = string.Empty;
    private bool _isLoading = false;

    private bool _rememberMe = false;
    private ModalData modalData = new();

    private async Task PerformLogin()
{
    if (string.IsNullOrWhiteSpace(_username) || string.IsNullOrWhiteSpace(_password))
    {
        Snackbar.Add("Please enter both email/username and password.", Severity.Warning);
        return;
    }
    _isLoading = true;
    var payload = new { usernameOrEmailOrPhone = _username, password = _password };
    try
    {
        var result = await Api.PostAsync<object, ResponseModel<LoginResponseData>>("auth/login", payload);
        @* var data = await ErrorHandler.ReadApiResponseAsync<LoginResponseData>(result); *@
        if (result?.Status == true)
        {
            UserState.Email = result.Data.Emailaddress;
            UserState.mobileNumber = result.Data.Mobilenumber;
            modalData = ErrorHandler.HandleApiError(result);
            StateHasChanged(); 
            if (result.Data.IsTwoFactorEnabled){
                Snackbar.Add($"Logged in as {result.Data.Emailaddress}", Severity.Success);
                NavManager.NavigateTo("/select-verification");
                return;
            }
            else{
                Snackbar.Add($"Logged in as {result.Data.Emailaddress}", Severity.Success);
                NavManager.NavigateTo("/");
            }
        }
        else
        {
            Snackbar.Add("Login failed. Please check credentials.", Severity.Error);
        }
    }
    catch (Exception ex)
    {
        Snackbar.Add("Error: " + ex.Message, Severity.Error);
    }
    finally
    {
        _isLoading = false;
    }
}

    private Task LoginWithFacebook() => Task.CompletedTask;
    private Task LoginWithGoogle() => Task.CompletedTask;
    public class LoginResponseData
{
    public string Username { get; set; }
    public string Mobilenumber { get; set; }
    public string Emailaddress { get; set; }
    public string AccessToken { get; set; }
    public string RefreshToken { get; set; }
    public bool IsTwoFactorEnabled { get; set; }
}

    private class LoginResult
    {
        public bool Success { get; set; }
        public MessageContent Message { get; set; }
    }

    private class MessageContent
    {
        public string JwtToken { get; set; }
        public string RefreshToken { get; set; }
    }
}

<style>
    .my-checkbox .mud-checkbox {
        border-radius: 6px;        
        border: none;
    }

    .my-checkbox input:checked + .mud-checkbox {
        background-color: #f97316;
    }

    .my-checkbox svg {
        @* stroke: white; *@
    }
</style>