@page "/verification-popup"
@inject NavigationManager NavManager
@using MudBlazor
@inject ISnackbar Snackbar
@inject ApiService Api
@using QLN.Blazor.Base.Services
@inject UserState UserState
@using MudBlazor.Components
@rendermode InteractiveServer
@using QLN.Blazor.Base.Models
@using QLN.Web.Shared.Components.CustomButton




 @if(_showSucess){ 
    <MudPaper Class="pa-6 mx-auto mt-10" 
          Style="max-width: 500px; border-radius: 12px; margin-top: 30px; margin-bottom: 30px; position: relative;">
    <MudStack Spacing="2" AlignItems="AlignItems.Center">
        
         <img src="images/success.svg" alt="Microsoft" style="width: 57px; height: 57px;" />
        
        <MudText Typo="Typo.h6" Align="Align.Center" Class="mt-2">Verification Successful</MudText>
        
        @if(isEmail){
        <MudText Typo="Typo.body2" Align="Align.Center" Class="mb-2">
            Your email has been successfully verified.
        </MudText>
        }
        else{
        <MudText Typo="Typo.body2" Align="Align.Center" Class="mb-2">
            Your phone number has been successfully verified.
        </MudText>
        }

        
        <CustomButton 
            BackgroundColor="#FF7F38"
            TextColor="#FFFFFF"
            Text="Continue"
            OnClick="@Close"
            Class="mt-4" />
    </MudStack>

</MudPaper>
 } 
 else{
<MudPaper Class="pa-6 mx-auto mt-10" 
          Style="max-width: 500px; border-radius: 12px; margin-top: 30px; margin-bottom: 30px; position: relative;">
    
    
    <MudStack Spacing="3">
        <MudText Typo="Typo.h5" Align="Align.Center">Verification Code Sent</MudText>
    @if(isEmail){
        <MudText Typo="Typo.caption" Align="Align.Center">
            We’ve sent a verification code to your email address.
        </MudText>
        }
        else{
        <MudText Typo="Typo.caption" Align="Align.Center">
            We’ve sent a verification code to your phone number.
        </MudText>
    }
        <MudText Typo="Typo.caption" Align="Align.Center">
            Please enter the code below to continue.
        </MudText>

        <MudTextField T="string"
                      Label="Verification Code"
                      Variant="Variant.Outlined"
                      FullWidth="true"
                      InputType="InputType.Text"
                      MaxLength="6"
                      @bind-Value="_code"
                      Required="true" /> 
 
        <CustomButton 
    BackgroundColor="#FF7F38"
    TextColor="#FFFFFF"
    Text="Verify"
    Disabled="_isLoading"
    OnClick="@VerifyCode"
    Class="mt-4">
</CustomButton>

        <MudText Align="Align.Center" Class="mt-4">
            Didn't receive a code?
            <MudLink Href="/signup" Class="ml-1" Style="color: #FF7F38;">Resend</MudLink>
        </MudText>
        <MudText Align="Align.Center"
                 Class="mud-clickable mt-2"
                 Style="color: #FF7F38; cursor: pointer;" 
                 @onclick="NavigateToForgotPassword">
            Use another verification method
        </MudText>
        <MudText Align="Align.Center"
                 Class="mud-clickable mt-2"
                 Style="color: #FF7F38; cursor: pointer;" 
                 @onclick="Close">
            Back to Sign Up
        </MudText>
    </MudStack>
</MudPaper>
} 

@code {
    [Parameter]
public bool ShowSuccess { get; set; }

 [Parameter]
public bool isEmail {get; set;} 

[Parameter]
public string email { get; set; } 

    private string _code = string.Empty;
    private bool _isLoading = false;
    private bool _showSucess = false;
    
    [Parameter] public EventCallback OnClose { get; set; }
    
    private async Task Close()
    {
        await OnClose.InvokeAsync();
    }
    
    private void NavigateToForgotPassword()
    {
        NavManager.NavigateTo("/login");
    }
    
    private async Task VerifyCode()
    {
        _isLoading = true;
        if (string.IsNullOrWhiteSpace(_code))
        {
            Snackbar.Add("Enter the verification code", Severity.Warning);
            _isLoading = false;
            return;
        }
        if (_code.Length != 6 || !_code.All(char.IsDigit))
        {
            Snackbar.Add("Enter a Valid Verification Code", Severity.Warning);
            _isLoading = false;
            return;
        }
        try
        {
            
            if (isEmail)
            {
              var payload = new { email = email, otp = _code };
              Console.WriteLine(payload);
                var res = await Api.PostAsync<object, ResponseModel<object>>("auth/verify-email-otp", payload);
                
                Console.WriteLine(res?.Status);
                if (res?.Status == true)
                {
                    ShowSuccess = true;
                }
                else
                {
                    Snackbar.Add(res?.Message ?? "Failed to verify email.", Severity.Warning);
                }
            }
            else
            {

                var body = new { phoneNumber = email, otp = _code };
                Console.WriteLine(body);
                var res = await Api.PostAsync<object, ResponseModel<object>>("auth/verify-phone-otp", body);
                Console.WriteLine(res?.Status);
                if (res?.Status == true)
                {
                    ShowSuccess = true;
                }
                else
                {
                    Snackbar.Add(res?.Message ?? "Failed to verify email.", Severity.Warning);
                }
                
            }
            
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Signup failed: {ex.Message}", Severity.Error);
        }
        finally
        {
            _showSucess = true;
            _isLoading = false;
        }
    }

    


}

<style>
    .otp-box input {
        text-align: center;
        font-size: 24px;
        padding: 12px;
        border-radius: 8px;
    }
</style>